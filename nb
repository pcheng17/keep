#!/usr/bin/env ruby

require "date"
require "erb"
require "json"

MAJOR = 1
MINOR = 0
PATCH = 3
OUTPUT_DIR = 'public'

def version
  return "#{MAJOR}.#{MINOR}.#{PATCH}"
end

def generated
  return Time.now.to_i
end

# Helper function to get week identifier (year-week)
def get_week_identifier(date_str)
  date = Date.parse(date_str)
  year = date.year
  first_day_of_week = date - date.wday
  week_num = date.strftime('%V').to_i
  [week_num, year, first_day_of_week.strftime('%b %d, %Y')]
end

start_time = Time.now

# Read the JSON file
json_data = File.read('data.json')
entries = JSON.parse(json_data)

# Group entries by week
entries_by_week = entries.group_by { |entry| get_week_identifier(entry['date']) }
total_weeks = entries_by_week.keys.length

# Read and process the template
template = File.read('template.html.erb')
renderer = ERB.new(template)
html_content = renderer.result(binding)

# First make sure the build directory exists
Dir.mkdir(OUTPUT_DIR) unless Dir.exist?(OUTPUT_DIR)

# Write the HTML file
File.write("./#{OUTPUT_DIR}/index.html", html_content)
puts "HTML file has been generated as './build/index.html'"

end_time = Time.now
duration = end_time - start_time
puts "Time taken: #{duration} seconds"
